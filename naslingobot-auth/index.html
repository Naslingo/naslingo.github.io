<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>NaslingoBot Auth</title>
  <style>
    body { font-family: sans-serif; background: #111; color: #eee; text-align: center; padding: 2em; }
    button { padding: 1em 2em; font-size: 1em; background: #1db954; color: white; border: none; cursor: pointer; }
    pre { background: #222; padding: 1em; border-radius: 5px; overflow-x: auto; }
    .error { color: #ff4c4c; margin-top: 1em; }
    .success { color: #4cff88; margin-top: 1em; }
  </style>
</head>
<body>
  <h1>NaslingoBot Auth</h1>
  <button id="authButton">Iniciar sesión con Spotify</button>
  <div id="output"></div>

  <script>
    const client_id = "06e21456c32841059192ce9a15b2b530";
    const redirect_uri = "https://naslingo.github.io/naslingobot-auth";
    const github_token = localStorage.getItem("github_token") || "";

    let code_verifier = localStorage.getItem("code_verifier") || "";

    function generateCodeVerifier() {
      const array = new Uint8Array(64);
      window.crypto.getRandomValues(array);
      return btoa(String.fromCharCode(...array)).replace(/[^a-zA-Z0-9]/g, "").substring(0, 128);
    }

    async function generateCodeChallenge(verifier) {
      const data = new TextEncoder().encode(verifier);
      const digest = await window.crypto.subtle.digest("SHA-256", data);
      return btoa(String.fromCharCode(...new Uint8Array(digest)))
        .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
    }

    async function startAuth() {
      code_verifier = generateCodeVerifier();
      localStorage.setItem("code_verifier", code_verifier);
      const code_challenge = await generateCodeChallenge(code_verifier);
      const params = new URLSearchParams({
        response_type: "code",
        client_id,
        redirect_uri,
        code_challenge_method: "S256",
        code_challenge,
        scope: "playlist-modify-public"
      });
      window.location = `https://accounts.spotify.com/authorize?${params.toString()}`;
    }

    async function handleRedirect() {
      const params = new URLSearchParams(window.location.search);
      const code = params.get("code");
      if (!code) return;

      const body = new URLSearchParams({
        grant_type: "authorization_code",
        code,
        redirect_uri,
        client_id,
        code_verifier
      });

      const response = await fetch("https://accounts.spotify.com/api/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body
      });

      const data = await response.json();
      document.getElementById("output").innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;

      if (data.refresh_token) {
        const content = btoa(JSON.stringify({ refresh_token: data.refresh_token }, null, 2));
        const upload = await fetch("https://api.github.com/repos/naslingo/naslingo.github.io/contents/naslingobot-auth/token.json", {
          method: "PUT",
          headers: {
            "Authorization": `Bearer ${github_token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            message: "Subida automática de refresh_token",
            content
          })
        });

        const result = await upload.json();
        if (result.content) {
          document.getElementById("output").innerHTML += `<div class="success">✅ token.json subido correctamente</div>`;
        } else {
          document.getElementById("output").innerHTML += `<div class="error">❌ Error al subir token.json</div><pre>${JSON.stringify(result, null, 2)}</pre>`;
        }
      } else {
        document.getElementById("output").innerHTML += `<div class="error">❌ No se recibió refresh_token</div>`;
      }
    }

    // ✅ Conectar el botón después de definir la función
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("authButton").addEventListener("click", startAuth);
      handleRedirect();
    });
  </script>
</body>
</html>
